# Implementation Plan: Tweet Character Counter

**Feature ID:** 908-tweet-character-counter
**Created:** 2025-10-15
**Status:** draft

---

## Tech Stack Compliance Report
<!-- Auto-generated by SpecSwarm tech stack validation -->

### ✅ Approved Technologies (already in stack)

All technologies used in this feature are already approved:
- **React** (functional components with hooks)
- **TypeScript** (strict mode)
- **Tailwind CSS** (utility classes for styling)
- **Flowbite** (design system patterns)
- **Zod** (validation schemas)

### ➕ New Technologies (auto-added)

**None** - This feature uses only existing approved technologies.

### ⚠️ Conflicting Technologies (require approval)

**None** - No conflicts detected.

### ❌ Prohibited Technologies (cannot use)

**None** - No prohibited technologies used.

**Compliance Status**: ✅ PASSED - All technologies approved, proceeding with plan generation.

---

## Constitution Compliance Check

Before proceeding, verify this plan complies with ALL principles in `/memory/constitution.md`:

- [x] **Principle 1 (Functional Programming):** Pure functions for character count logic (getColorState, isSubmitAllowed), no classes
- [x] **Principle 2 (Type Safety):** TypeScript types for all component props and state, Zod validation already exists for tweet content
- [ ] **Principle 3 (Programmatic Routing):** Not applicable - no routing changes
- [ ] **Principle 4 (Security-First):** Not applicable - client-side UI only, server validation already exists
- [x] **Principle 5 (Modern React):** Functional components, hooks (useState, useMemo), presentational component pattern

**Compliance Notes:**
- This is a pure frontend enhancement to existing TweetComposer component
- Server-side validation already enforces 140-character limit (src/server/routes/tweets.ts via Zod schema)
- Character counter provides UX feedback only, not security control
- All new code follows functional programming patterns with pure helper functions

---

## Overview

**Goal:** Enhance the existing tweet composition experience with improved character counter that shows "X / 140" format, provides visual warnings at 120 characters (yellow) and 140 characters (red), and disables submission when over limit.

**User Value:** Users get clearer, more immediate feedback about character limit proximity, reducing submission errors and improving composition confidence.

**Scope:**
- **Included:**
  - Modify existing TweetComposer component to show "X / 140" format
  - Add three-state color system (default, warning at 120, exceeded at 140)
  - Implement visual transitions between states
  - Ensure accessibility with aria-live and proper color contrast
  - Add pure helper functions for color state determination

- **Excluded:**
  - No backend/API changes (validation already exists)
  - No database schema changes
  - No new routes or pages
  - No configurable character limits (hardcoded 140)
  - No animation effects (could be added in future P2 iteration)

---

## Technical Approach

### Architecture

**Component Strategy:**
- Enhance existing `TweetComposer` component with improved counter display
- Extract character counter logic into pure helper functions
- Optional: Create separate `CharacterCounter` presentational component for clarity and reusability

**Functional Patterns:**
- Pure function: `getColorState(count: number, maxLength: number): CounterColorState`
- Pure function: `isSubmitAllowed(count: number, maxLength: number): boolean`
- Pure function: `formatCounter(count: number, maxLength: number): string`
- Use useMemo to memoize color state calculations (performance optimization)

**Data Flow:**
1. User types → textarea onChange handler
2. Update local state with content
3. Calculate count = content.length
4. Compute color state from count (pure function)
5. Render counter with appropriate styling
6. Enable/disable submit button based on count

### Data Model Changes

**Database Changes:**
- [ ] No database changes required

**Type Definitions:**
```typescript
// app/components/TweetComposer.tsx or new app/utils/tweetCounter.ts

/**
 * Character counter color state
 */
type CounterColorState = 'default' | 'warning' | 'exceeded';

/**
 * Character counter component props (if extracted)
 */
interface CharacterCounterProps {
  count: number;
  maxLength: number;
  colorState: CounterColorState;
}

/**
 * Pure helper functions interface (for documentation/testing)
 */
interface TweetCounterHelpers {
  getColorState: (count: number, maxLength: number) => CounterColorState;
  isSubmitAllowed: (count: number, maxLength: number) => boolean;
  formatCounter: (count: number, maxLength: number) => string;
}
```

**Zod Schemas:**
- No new schemas required (tweet content validation already exists in backend)
- Frontend form validation uses same max length constant (140)

### API Design

**New Endpoints:**
- None - purely client-side enhancement

**Modified Endpoints:**
- None - backend validation unchanged

### Frontend Components

**Modified Components:**

1. **TweetComposer** (`app/components/TweetComposer.tsx`)
   - Change counter display from "{X} characters remaining" to "{count} / 140" format
   - Add color state calculation based on character count thresholds
   - Update CSS classes for three-state coloring (default, warning, exceeded)
   - Ensure smooth visual transitions with Tailwind transition classes
   - Maintain existing functionality (submission prevention, form reset, error handling)

**New Components (Optional Refactor):**

2. **CharacterCounter** (`app/components/CharacterCounter.tsx`) - Optional extraction
   - Pure presentational component
   - Props: count, maxLength
   - Computes color state internally or receives it as prop
   - Displays formatted counter with appropriate styling
   - Benefits: reusability, testability, separation of concerns

**Helper Functions (New File):**

3. **tweetCounterHelpers** (`app/utils/tweetCounter.ts`) - Recommended extraction
   - Pure functions for character counting logic
   - Fully unit testable without React
   - Reusable across components if needed in future

**Routing Changes:**
```typescript
// No changes to app/routes.ts - component enhancement only
```

### State Management

**Local Component State:**
- Existing: `content` (string) - tweet text
- Computed values (no additional state):
  - `count` = content.length
  - `colorState` = getColorState(count, 140)
  - `isOverLimit` = count > 140
  - `isInvalid` = isEmpty || isOverLimit

**No global state needed** - character counter is local to composition experience.

**Performance Optimization:**
- Use `useMemo` to memoize color state calculation (avoid recalculation on every render)
- Example:
  ```typescript
  const colorState = useMemo(() => getColorState(content.length, 140), [content.length]);
  ```

---

## Security Considerations

- [x] Input validation with Zod on client and server
  - ✅ Backend already validates max 140 characters via Zod schema
  - ✅ Frontend counter provides UX feedback only (not security boundary)

- [x] Authentication requirements identified
  - ✅ TweetComposer only accessible to authenticated users (existing route protection)

- [x] Authorization checks in place
  - ✅ Existing authentication middleware on /feed route

- [x] No sensitive data in localStorage/client state
  - ✅ Character counter operates on user's own draft content (not sensitive)

- [x] Parameterized database queries only
  - ✅ Not applicable (no database queries in this feature)

**Security Notes:**
- Client-side disabled button can be bypassed via dev tools or direct API calls
- This is acceptable: server-side validation is the security boundary
- Character counter is a UX enhancement, not a security control

---

## Testing Strategy

### Unit Tests

**Pure Functions** (`app/utils/tweetCounter.test.ts`):
- [ ] `getColorState(count, maxLength)` tested with:
  - count = 0 → returns 'default'
  - count = 119 → returns 'default'
  - count = 120 → returns 'warning'
  - count = 139 → returns 'warning'
  - count = 140 → returns 'exceeded'
  - count = 141 → returns 'exceeded'
  - count = 200 → returns 'exceeded'

- [ ] `isSubmitAllowed(count, maxLength)` tested with:
  - count = 0, isEmpty = true → returns false
  - count = 50, isEmpty = false → returns true
  - count = 140, isEmpty = false → returns true
  - count = 141, isEmpty = false → returns false

- [ ] `formatCounter(count, maxLength)` tested with:
  - count = 0, maxLength = 140 → returns "0 / 140"
  - count = 120, maxLength = 140 → returns "120 / 140"
  - count = 140, maxLength = 140 → returns "140 / 140"
  - count = 150, maxLength = 140 → returns "150 / 140"

**Component Tests** (`app/components/TweetComposer.test.tsx`):
- [ ] TweetComposer renders with "0 / 140" counter initially
- [ ] Counter updates to "5 / 140" when 5 characters typed
- [ ] Counter has default color when count < 120
- [ ] Counter has warning color (yellow/amber) when count >= 120
- [ ] Counter has exceeded color (red) when count >= 140
- [ ] Submit button disabled when count > 140
- [ ] Submit button enabled when count <= 140 and content not empty
- [ ] Counter has aria-live="polite" attribute
- [ ] Color changes are visually distinguishable (snapshot testing)

### Integration Tests

**TweetComposer Integration** (`tests/integration/tweetComposer.test.ts`):
- [ ] Typing in textarea updates character counter in real-time
- [ ] Counter transitions from default → warning at 120 characters
- [ ] Counter transitions from warning → exceeded at 140 characters
- [ ] Submit button toggles disabled state correctly based on count
- [ ] Form submission blocked when count > 140 (button disabled)
- [ ] Form submission succeeds when count <= 140
- [ ] Editing content below 140 re-enables submit button

### Manual Testing Checklist

**Visual Testing:**
- [ ] Counter displays "0 / 140" initially
- [ ] Counter updates immediately as user types (no lag)
- [ ] Color transition to yellow/amber is smooth and noticeable at 120 chars
- [ ] Color transition to red is smooth and noticeable at 140 chars
- [ ] Submit button visually appears disabled when over limit
- [ ] Color contrast meets WCAG AA standards (use browser dev tools)

**Accessibility Testing:**
- [ ] Screen reader announces character count changes (test with NVDA/JAWS)
- [ ] Screen reader announces state changes at thresholds
- [ ] Counter text is readable at all color states
- [ ] Keyboard navigation works (tab to textarea, type, tab to submit)
- [ ] Disabled button cannot be focused or activated via keyboard

**Edge Cases:**
- [ ] Exactly 140 characters: counter red, button enabled
- [ ] Exactly 141 characters: counter red, button disabled
- [ ] Copy-paste large text: counter updates correctly, button disabled
- [ ] Emojis and special characters counted correctly (use .length property)
- [ ] Rapid typing: counter updates smoothly without flickering

---

## Implementation Phases

### Phase 1: Pure Helper Functions
**Tasks:**
1. Create `app/utils/tweetCounter.ts` file
2. Implement `getColorState(count, maxLength)` pure function
3. Implement `isSubmitAllowed(count, maxLength)` pure function
4. Implement `formatCounter(count, maxLength)` pure function
5. Write unit tests for all three functions (vitest)
6. Verify tests pass with 100% coverage for helper functions

**Deliverables:**
- Tested, pure helper functions ready for integration
- No UI changes yet

**Estimated Time:** 30-45 minutes

### Phase 2: Component Integration
**Tasks:**
1. Import helper functions into `TweetComposer.tsx`
2. Replace existing counter calculation with `formatCounter()`
3. Add `useMemo` for color state calculation
4. Update counter display from "X characters remaining" to "X / 140"
5. Update CSS classes to use three-state color system:
   - Default: `text-gray-600` (existing)
   - Warning: `text-yellow-600` (new - 120-139 chars)
   - Exceeded: `text-red-600` (existing - 140+ chars)
6. Add Tailwind transition class for smooth color changes: `transition-colors duration-200`
7. Test component renders correctly with different character counts

**Deliverables:**
- Enhanced TweetComposer with new counter format and color states
- Visual feedback at 120 and 140 character thresholds

**Estimated Time:** 30-45 minutes

### Phase 3: Accessibility & Polish
**Tasks:**
1. Verify `aria-live="polite"` on counter element (already exists)
2. Add descriptive aria-label if needed: `aria-label="Character count: {count} of 140"`
3. Ensure submit button has `aria-disabled="true"` when disabled
4. Test color contrast ratios for all three states (WCAG AA compliance):
   - Default gray: verify contrast against white background
   - Warning yellow: verify contrast (may need darker shade)
   - Exceeded red: verify contrast
5. Adjust colors if needed to meet WCAG AA (4.5:1 for normal text)
6. Add CSS transitions for smooth color changes
7. Manual accessibility testing with screen reader

**Deliverables:**
- WCAG-compliant color contrast
- Smooth visual transitions
- Screen reader compatible

**Estimated Time:** 30-45 minutes

### Phase 4: Testing & Documentation
**Tasks:**
1. Write component tests for TweetComposer (React Testing Library)
2. Write integration tests for character counter behavior
3. Run full test suite and ensure all tests pass
4. Manual testing checklist completion
5. Browser compatibility testing (Chrome, Firefox, Safari)
6. Update component documentation (JSDoc comments)
7. Create PR with clear description of changes

**Deliverables:**
- Comprehensive test coverage
- All acceptance criteria met
- Production-ready code

**Estimated Time:** 45-60 minutes

---

## Dependencies

**External Dependencies:**
- [x] Tailwind CSS (already in project) - for utility classes
- [x] Flowbite (already in project) - for design system consistency
- [x] React Testing Library (already in project) - for component testing
- [x] Vitest (already in project) - for unit testing

**Internal Dependencies:**
- [x] Existing TweetComposer component (`app/components/TweetComposer.tsx`)
- [x] Existing tweet creation action (`app/actions/tweets.ts`)

**Blockers:**
- None - all prerequisites met

---

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Color contrast insufficient for yellow warning state | Medium | Medium | Test with WCAG contrast checker, use darker amber (yellow-700 or yellow-800) if needed |
| Performance issue with real-time updates | Low | Low | Use useMemo for color state calculation, debounce if needed (unlikely for simple length check) |
| Screen reader announces too frequently | Medium | Low | Use aria-live="polite" (not "assertive"), test with actual screen reader |
| Visual transitions jarring or distracting | Low | Low | Use subtle transition duration (200ms), test with users |
| Breaking existing TweetComposer functionality | Medium | Low | Comprehensive integration tests, thorough manual testing before merge |
| Emojis counted incorrectly | Low | Low | JavaScript .length counts UTF-16 code units (standard behavior), document if needed |

---

## Success Criteria

- [x] Feature works as specified in acceptance criteria
- [ ] All unit tests pass (pure functions)
- [ ] All integration tests pass (component behavior)
- [ ] Constitution principles followed (functional patterns, TypeScript, modern React)
- [ ] No TypeScript errors in strict mode
- [ ] No security vulnerabilities introduced (N/A - client-side only)
- [ ] Code reviewed and approved
- [ ] WCAG AA color contrast compliance
- [ ] Screen reader testing successful
- [ ] Zero perceptible lag when typing (performance validated)

**Specific Acceptance Criteria from Spec:**
- [ ] Character counter displays in format "X / 140" where X is current count
- [ ] Counter updates in real-time as user types
- [ ] Counter turns yellow when count reaches 120
- [ ] Counter turns red when count reaches 140
- [ ] Submit button disabled when count exceeds 140
- [ ] Submit button re-enabled when count edited back to ≤ 140
- [ ] Color changes are immediate and smooth
- [ ] Disabled state is visually apparent

---

## Rollback Plan

**If issues arise post-merge:**

1. **Immediate Rollback** (< 5 minutes):
   - Revert the PR commit
   - Redeploy previous version
   - TweetComposer returns to "X characters remaining" format

2. **Partial Rollback** (keep tests, revert UI):
   - Keep helper functions and tests (no harm)
   - Revert TweetComposer changes only
   - Allows quick re-implementation after fixing issues

3. **Data Safety:**
   - No data migrations involved
   - No database changes
   - No API changes
   - Rollback has zero data risk

---

## Documentation Updates

- [ ] **Component Documentation**: Add JSDoc comments to helper functions explaining thresholds
- [ ] **Code Comments**: Document the three color states (default, warning, exceeded)
- [ ] **Testing Documentation**: Update test README if needed with character counter test examples
- [ ] **CLAUDE.md Updates**: Not needed (no architectural changes)
- [ ] **README Updates**: Not needed (internal enhancement)

---

## Notes

**Design Decisions:**

1. **"X / 140" vs "X characters remaining"**: Spec requires "X / 140" format for clarity and consistency with Twitter/X pattern. Users find progress-style counters ("5 / 140") more intuitive than remaining counters ("135 remaining").

2. **Yellow at 120, Red at 140**: Two-tier warning system provides:
   - Early warning at 120 (20 chars remaining) - time to rethink wording
   - Hard limit warning at 140 (0 chars remaining) - submission blocked
   - This matches user expectations from similar platforms

3. **Pure Functions Strategy**: Extract logic into pure functions for:
   - Easy unit testing without React complexity
   - Reusability across components
   - Clear separation of business logic from UI
   - Follows Principle 1 (Functional Programming)

4. **Accessibility First**: aria-live="polite" ensures screen reader users get updates without interruption. Color is not the only indicator (text changes too: "120 / 140").

5. **Performance**: useMemo prevents unnecessary recalculations, but for simple string length checks this is micro-optimization. Include for best practices and future-proofing.

**Current State Analysis:**
- TweetComposer already has character counter showing "X characters remaining"
- Already disables submit button when over limit
- Already has aria-live region
- Needs: format change, yellow warning state, smoother color transitions

**Future Enhancements (Out of Scope for 908):**
- Animation/pulse effect at thresholds (P2 requirement)
- Tooltip with helpful tips (P2 requirement)
- Character count persistence with draft saving (P2 requirement)
- Different thresholds for different content types (explicitly excluded)

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-10-15 | Initial implementation plan | SpecSwarm + Claude Code |
