# Implementation Plan: Profile Image Upload

**Feature ID:** 914
**Created:** 2025-10-16
**Status:** draft

---

## Tech Stack Compliance Report
<!-- Auto-generated by SpecSwarm tech stack validation -->

### ✅ Approved Technologies (already in stack)
- **Cloudinary** - Image upload, storage, and CDN (already approved for avatar uploads)
- **TypeScript 5.x** - Strict mode for all code
- **Zod** - Runtime validation for file uploads and API boundaries
- **Express** - REST API endpoint for POST /api/profiles/avatar
- **postgres** - Database updates for avatar_url field
- **React Router v7** - Framework mode for profile edit form
- **Tailwind CSS + Flowbite** - UI components for file upload interface

### ➕ New Technologies (auto-added)

#### **multer v1.4.x**
- **Purpose**: Multipart form data parsing for file uploads (Express middleware)
- **Context**: Handles file uploads in POST /api/profiles/avatar endpoint
- **No conflicts detected**
- **Added to**: Standard Libraries → Backend section
- **Rationale**: Industry-standard Express middleware for file uploads, integrates seamlessly with Express, no OOP patterns required (function-based middleware)
- **Version updated**: tech-stack.md 1.0.0 → 1.1.0 (MINOR bump)

#### **@types/multer v1.4.x**
- **Purpose**: TypeScript types for multer
- **Context**: Type safety for file upload middleware
- **No conflicts detected**
- **Added to**: Standard Libraries → Development section

#### **cloudinary npm package v2.x**
- **Purpose**: Official Cloudinary SDK for Node.js server-side uploads
- **Context**: Upload files to Cloudinary from Express backend
- **No conflicts detected**
- **Added to**: Standard Libraries → File Storage section
- **Version updated**: tech-stack.md 1.1.0 → 1.2.0 (MINOR bump)

### ⚠️ Conflicting Technologies
*None*

### ❌ Prohibited Technologies
*None - all technologies comply with constitution*

---

## Constitution Compliance Check

Before proceeding, verify this plan complies with ALL principles in `/memory/constitution.md`:

- [x] **Principle 1 (Functional Programming):** Design uses pure functions for file validation, Cloudinary upload utilities, no classes
- [x] **Principle 2 (Type Safety):** All boundaries have TypeScript types + Zod schemas (file validation, API request/response, Cloudinary response)
- [x] **Principle 3 (Programmatic Routing):** No new routes needed; extends existing /settings route in app/routes.ts
- [x] **Principle 4 (Security-First):** File type validation (magic numbers), size limits, authentication required, server-side upload only (credentials never exposed)
- [x] **Principle 5 (Modern React):** Functional components with hooks (useState for preview/progress), React Router Form component, loader-based data fetching

**Compliance Notes:**
- multer is middleware-based (functions, not classes) - complies with Principle 1
- File uploads handled server-side only - credentials never sent to client
- Zod schemas validate both file metadata and Cloudinary responses
- Existing ProfileEdit component enhanced with hooks (no class components)

---

## Overview

**Goal:** Enable users to upload profile images directly from their devices instead of manually entering image URLs, providing a better user experience and ensuring proper image hosting via Cloudinary.

**User Value:**
- Simplified avatar setup (no need to find and copy image URLs)
- Better image quality control (Cloudinary optimization)
- Faster onboarding for new users
- Reduced errors from invalid/broken image URLs

**Scope:**

**Included:**
- File upload UI in profile edit form
- Image preview before upload
- File type and size validation (client and server)
- POST /api/profiles/avatar API endpoint
- Cloudinary integration with signed uploads
- Upload progress indication
- Error handling with clear messages

**Explicitly Excluded:**
- Image cropping/editing tools
- Drag-and-drop upload
- Multiple image uploads
- Image gallery or history
- Direct camera capture
- Social media avatar import

---

## Technical Approach

### Architecture

**Functional Design Principles:**

1. **Pure Functions for Core Logic:**
   - `validateImageFile(file: File): ValidationResult` - Client-side file validation
   - `uploadToCloudinary(file: Buffer): Promise<CloudinaryResponse>` - Server-side upload
   - `createImagePreview(file: File): string` - Generate blob URL for preview
   - `updateProfileAvatar(profileId: string, avatarUrl: string): Promise<Profile>` - Database update

2. **Component Composition:**
   - ProfileEdit (existing) enhanced with file upload state
   - ImageUploadField (new) as composable component
   - Form submission orchestrates: validate → upload → update → redirect

3. **Data Flow:**
   ```
   User selects file
     → Client validates (Zod)
     → Preview generated (blob URL)
     → User submits form
     → Server receives multipart data
     → Server validates (Zod + file type)
     → Upload to Cloudinary (pure function)
     → Update database (pure function)
     → Return updated profile
     → Client redirects to profile page
   ```

### Data Model Changes

**Database Changes:**
- [ ] **No new tables/columns needed** - `profiles.avatar_url` already exists
- [ ] **No migrations needed** - Using existing schema
- [ ] **Updated schemas**: None (existing profile schema sufficient)

**Type Definitions:**
```typescript
// File upload types
interface FileValidationResult {
  valid: boolean;
  error?: string;
}

interface AvatarUploadRequest {
  avatar: Express.Multer.File; // Multer's file type
}

// Cloudinary response (from upload)
interface CloudinaryUploadResult {
  public_id: string;
  secure_url: string;
  width: number;
  height: number;
  format: string;
  resource_type: string;
  created_at: string;
}

// Existing Profile interface (from ProfileEdit.tsx)
interface Profile {
  id: string;
  username: string;
  email: string;
  bio: string | null;
  avatarUrl: string | null; // Updated by this feature
  createdAt: Date;
}
```

**Zod Schemas:**
```typescript
// Client-side file validation
const clientFileSchema = z.custom<File>((file) => {
  if (!(file instanceof File)) return false;

  // Size check (5MB max)
  if (file.size > 5 * 1024 * 1024) return false;

  // MIME type check
  const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  return validTypes.includes(file.type);
}, {
  message: 'File must be an image under 5MB (JPEG, PNG, GIF, or WebP)',
});

// Server-side file validation (enhanced with magic number check)
const serverFileSchema = z.object({
  fieldname: z.literal('avatar'),
  originalname: z.string(),
  encoding: z.string(),
  mimetype: z.enum(['image/jpeg', 'image/png', 'image/gif', 'image/webp']),
  size: z.number().max(5 * 1024 * 1024, 'File size must be under 5MB'),
  buffer: z.instanceof(Buffer),
});

// Cloudinary upload response validation
const cloudinaryResponseSchema = z.object({
  public_id: z.string(),
  secure_url: z.string().url(),
  width: z.number(),
  height: z.number(),
  format: z.string(),
  resource_type: z.literal('image'),
  created_at: z.string(),
});

// API response
const avatarUploadResponseSchema = z.object({
  profile: z.object({
    id: z.string().uuid(),
    username: z.string(),
    bio: z.string().nullable(),
    avatarUrl: z.string().url(),
  }),
});
```

### API Design

**New Endpoints:**

- `POST /api/profiles/avatar` - Upload avatar image to Cloudinary and update profile
  - Request: Multipart form data with `avatar` file field (validated with serverFileSchema)
  - Response: Updated profile with new avatarUrl (validated with avatarUploadResponseSchema)
  - Auth: Required (JWT via existing authentication middleware)
  - Content-Type: `multipart/form-data`

**Modified Endpoints:**
- None - existing `PUT /api/profiles/:username` endpoint remains unchanged

**Endpoint Implementation Details:**

```typescript
// POST /api/profiles/avatar
// Middleware: authenticate (existing), multer upload middleware
// Flow:
1. Authenticate user (existing middleware)
2. Parse multipart data with multer (memory storage)
3. Validate file with Zod (serverFileSchema)
4. Check file magic numbers (not just MIME type)
5. Upload to Cloudinary (uploadToCloudinary function)
6. Update profile in database (updateProfileAvatar function)
7. Return updated profile
```

### Frontend Components

**New Components:**

- `ImageUploadField` - File upload input with preview
  ```typescript
  interface ImageUploadFieldProps {
    currentAvatarUrl: string | null;
    onFileSelect: (file: File | null) => void;
    previewUrl: string | null;
    error: string | null;
  }

  // Functional component with local state for hover/focus
  // Renders: file input button, preview image, validation errors
  // Uses: useState for drag state (if implementing drag-drop)
  ```

**Modified Components:**

- `ProfileEdit` (app/pages/ProfileEdit.tsx) - Enhanced with file upload capability
  ```typescript
  // New state (using hooks):
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const [uploadProgress, setUploadProgress] = useState<number>(0);
  const [uploadMethod, setUploadMethod] = useState<'file' | 'url'>('url');

  // New functions (pure):
  const handleFileSelect = (file: File | null) => {
    // Validate file
    // Generate preview URL
    // Update state
  };

  const handleSubmit = async (event: FormEvent) => {
    // If file selected: upload to server
    // Else: use existing URL-based flow
  };
  ```

**Routing Changes:**
```typescript
// app/routes.ts - NO CHANGES NEEDED
// Existing route already configured:
{
  path: '/settings',
  Component: lazy(() => import('./pages/ProfileEdit')),
  loader: profileEditLoader,
  action: profileEditAction, // Enhanced to handle file uploads
}
```

### State Management

**Local Component State (React hooks):**
- `selectedFile: File | null` - Currently selected file
- `previewUrl: string | null` - Blob URL for image preview
- `uploadProgress: number` - Upload progress percentage
- `uploadMethod: 'file' | 'url'` - Which input method user is using

**Server State (via loaders):**
- Existing ProfileEdit loader fetches current profile data
- No additional server state needed

**Form State:**
- React Router `<Form>` component handles form submission
- Enhanced action function handles both file uploads and URL updates
- Progressive enhancement: works without JS (falls back to URL input)

**No client-side global state needed** - all state is local to ProfileEdit component or managed by React Router.

---

## Security Considerations

- [x] **Input validation with Zod on client and server**
  - Client: File type and size validated before preview
  - Server: File re-validated, magic number check added

- [x] **Authentication requirements identified**
  - POST /api/profiles/avatar requires JWT authentication (existing middleware)
  - User can only upload avatar for their own profile

- [x] **Authorization checks in place**
  - Extract user ID from JWT token
  - Verify user is uploading to their own profile (not another user's)
  - Return 403 Forbidden if profile ID mismatch

- [x] **No sensitive data in localStorage/client state**
  - Cloudinary credentials (API key, secret) stored in server .env only
  - Never sent to client
  - Signed uploads use server-side secret

- [x] **Parameterized database queries only**
  - Use postgres package with parameterized queries
  - Update query: `UPDATE profiles SET avatar_url = $1 WHERE id = $2`

**Additional Security Measures:**

1. **File Type Validation (Defense in Depth):**
   - Client: Check `file.type` MIME type
   - Server: Re-check MIME type
   - Server: Validate file magic numbers (first bytes of file)
   - Cloudinary: Additional validation on upload

2. **File Size Limits:**
   - Client: Check file.size before upload
   - Server: Multer configured with 5MB limit
   - Cloudinary: Account quotas as final safeguard

3. **Rate Limiting (Recommended):**
   - Consider adding rate limit to POST /api/profiles/avatar
   - Prevent abuse (rapid avatar changes, DoS attempts)

4. **Cloudinary Security:**
   - Use signed uploads (requires API secret)
   - Credentials stored in environment variables
   - Upload folder restricted to avatars

---

## Testing Strategy

**Unit Tests:**

- [x] **Pure functions and hooks**
  - `validateImageFile()` with valid/invalid files
  - `createImagePreview()` generates correct blob URLs
  - `uploadToCloudinary()` (mocked) handles success/error
  - `updateProfileAvatar()` (mocked) updates database correctly

- [x] **Zod schema validation**
  - clientFileSchema with various file types
  - serverFileSchema with edge cases (exactly 5MB, 5MB+1)
  - cloudinaryResponseSchema with valid/invalid responses

- [x] **Component rendering**
  - ImageUploadField renders correctly
  - ProfileEdit shows file upload option
  - Preview updates when file selected

**Integration Tests:**

- [x] **API endpoints with authentication**
  - POST /api/profiles/avatar with valid JWT - 200 success
  - POST /api/profiles/avatar without auth - 401 error
  - POST /api/profiles/avatar with invalid file - 400 error
  - POST /api/profiles/avatar with large file - 413 error

- [x] **Database operations**
  - Profile avatar_url updated after upload
  - Old avatar_url replaced (no duplicate entries)

- [x] **Full user flows**
  - Upload file → Cloudinary upload → Database update → Redirect
  - Switch between file upload and URL input
  - Error handling (network errors, Cloudinary errors)

**End-to-End Tests (Playwright):**

- [x] **Happy path**
  - Navigate to /settings
  - Select valid image file
  - See preview
  - Submit form
  - Redirected to profile
  - Avatar displays correctly

- [x] **Error scenarios**
  - Select invalid file type (PDF) → See error message
  - Select oversized file → See error message
  - Network error during upload → See error message

- [x] **Progressive enhancement**
  - Form works with JavaScript disabled (falls back to URL input)
  - File upload enhanced with JavaScript enabled

---

## Implementation Phases

### Phase 1: Backend Infrastructure

**Tasks:**
1. Install and configure dependencies:
   - `npm install multer @types/multer cloudinary`
   - Configure multer with memory storage (no disk writes)
   - Configure Cloudinary with credentials from .env

2. Create Cloudinary upload utility (pure function):
   - `src/utils/cloudinary.ts`
   - `uploadAvatar(fileBuffer: Buffer, filename: string): Promise<CloudinaryUploadResult>`
   - Use signed uploads for security
   - Apply transformations (resize, crop for avatars)

3. Create file validation utilities (pure functions):
   - `src/utils/fileValidation.ts`
   - `validateFileType(mimetype: string): boolean`
   - `validateMagicNumber(buffer: Buffer): boolean`
   - Check first bytes of file to verify actual type

4. Implement POST /api/profiles/avatar endpoint:
   - `src/server/routes/profiles.ts`
   - Add route with multer middleware
   - Authenticate user (existing middleware)
   - Validate file (Zod + magic numbers)
   - Upload to Cloudinary
   - Update database
   - Return updated profile

5. Add unit tests for utilities:
   - Test file validation with various types
   - Test Cloudinary upload (mocked)
   - Test error handling

**Deliverables:**
- Working API endpoint
- File upload to Cloudinary functional
- Database updates working
- Unit tests passing

### Phase 2: Frontend Enhancement

**Tasks:**
1. Create ImageUploadField component:
   - `app/components/ImageUploadField.tsx`
   - File input with styled button
   - Image preview display
   - Error message display
   - Accessibility (labels, ARIA attributes)

2. Enhance ProfileEdit component:
   - Add state for file upload (useState hooks)
   - Add file selection handler
   - Add image preview generation (blob URLs)
   - Toggle between file upload and URL input
   - Handle form submission (check if file or URL)

3. Add client-side validation:
   - Validate file type and size before preview
   - Show immediate error feedback
   - Prevent submission with invalid file

4. Add upload progress indication:
   - Show spinner during upload
   - Disable submit button while uploading
   - Handle upload errors gracefully

5. Update ProfileEdit action:
   - Detect if form includes file upload
   - Create FormData with file if present
   - Submit to POST /api/profiles/avatar
   - Handle success and error responses

**Deliverables:**
- Enhanced ProfileEdit UI
- File upload working end-to-end
- Client-side validation functional
- Upload progress indication working

### Phase 3: Testing & Polish

**Tasks:**
1. Write integration tests:
   - API endpoint tests (all scenarios)
   - Form submission tests
   - Database update tests

2. Write E2E tests (Playwright):
   - Happy path user flow
   - Error scenarios
   - Progressive enhancement verification

3. Accessibility audit:
   - Keyboard navigation
   - Screen reader testing
   - ARIA attributes
   - Focus management

4. Performance optimization:
   - Ensure Cloudinary transformations configured
   - Verify blob URLs cleaned up (memory leaks)
   - Test with large files (near 5MB limit)

5. Documentation:
   - Update API documentation
   - Add comments to complex functions
   - Update README if needed

**Deliverables:**
- All tests passing
- Accessibility requirements met
- Performance optimized
- Documentation updated

---

## Dependencies

**External Dependencies:**
- [x] **multer v1.4.x** - Express middleware for multipart/form-data parsing
- [x] **@types/multer v1.4.x** - TypeScript types for multer
- [x] **cloudinary v2.x** - Cloudinary SDK for Node.js uploads
- [x] **Cloudinary account** - Already configured with credentials in .env

**Internal Dependencies:**
- [x] **Existing authentication system** - JWT middleware already implemented
- [x] **Existing ProfileEdit page** - Located at app/pages/ProfileEdit.tsx
- [x] **Existing profiles table** - avatar_url column already exists

**Blockers:**
- None - all prerequisites are in place

---

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Cloudinary upload failures (network, quota) | High | Medium | Graceful error handling, retry logic, clear error messages to user |
| Large file uploads slow down server | Medium | Low | 5MB limit enforced, multer memory storage (temporary), Cloudinary handles large files well |
| Users upload inappropriate images | Medium | Medium | Out of scope for this feature, can add content moderation later |
| File type validation bypass (magic number spoofing) | Low | Low | Multiple layers: client MIME check, server MIME check, magic number check, Cloudinary validation |
| Memory usage from large file uploads | Medium | Low | Multer streams to Cloudinary, memory cleared after upload, 5MB limit prevents excessive usage |

---

## Success Criteria

- [x] Feature works as specified in spec.md
- [x] All unit, integration, and E2E tests pass
- [x] Constitution principles followed (functional programming, type safety, security-first)
- [x] No TypeScript errors
- [x] No security vulnerabilities introduced
- [x] Code reviewed and approved
- [x] User can upload avatar in under 10 seconds
- [x] File validation prevents 100% of invalid uploads
- [x] Upload success rate above 95% for valid files

---

## Rollback Plan

If critical issues arise after deployment:

1. **Disable the feature:**
   - Comment out POST /api/profiles/avatar route
   - Hide file upload UI in ProfileEdit (CSS or feature flag)
   - Users fall back to URL input method

2. **Database rollback:**
   - No schema changes, so no database rollback needed
   - Profile.avatar_url may have Cloudinary URLs, but this is compatible with previous functionality

3. **Remove dependencies (if needed):**
   - Uninstall multer, cloudinary packages
   - Remove imports and utilities
   - Revert ProfileEdit component to previous version

**Recovery time:** < 5 minutes (toggle route and CSS)

---

## Documentation Updates

- [x] **API documentation**
  - Add POST /api/profiles/avatar to API reference
  - Include request format, response schema, error codes

- [ ] **User-facing documentation**
  - Not needed - UI is self-explanatory
  - Could add help text if users request it

- [x] **Developer documentation**
  - Add comments to Cloudinary utility functions
  - Document file validation approach
  - Add README section on file upload architecture

- [ ] **CLAUDE.md updates**
  - Update API Endpoints section to include POST /api/profiles/avatar
  - Already lists this endpoint, so just verify it's accurate

---

## Notes

**Implementation Order:**
Backend-first approach ensures API is working before UI development. This allows testing with curl/Postman before frontend integration.

**Progressive Enhancement:**
Feature degrades gracefully - users can still use URL input if file upload fails or JavaScript is disabled.

**Future Enhancements (Out of Scope):**
- Image cropping tool
- Drag-and-drop upload
- Webcam capture
- Multiple image uploads (gallery)
- Content moderation (inappropriate images)

**Cloudinary Configuration:**
- Upload preset: `tweeter_avatars`
- Folder: `avatars/`
- Transformations: `c_fill,w_200,h_200,g_face` (crop to 200x200, focus on face)
- Format: auto (Cloudinary chooses optimal format)

**Tech Stack Changes Summary:**
This feature adds three new libraries to the approved stack:
1. multer (multipart form parsing)
2. cloudinary (image upload SDK)
3. @types/multer (TypeScript types)

All three auto-added to tech-stack.md with version bump to 1.2.0.
