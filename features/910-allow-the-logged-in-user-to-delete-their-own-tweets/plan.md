# Implementation Plan: Tweet Deletion

**Feature ID:** 910-allow-the-logged-in-user-to-delete-their-own-tweets
**Created:** 2025-10-15
**Status:** approved
**Estimated Effort:** 3-4 hours

---

## Tech Stack Compliance Report
<!-- Auto-generated by SpecSwarm tech stack validation -->

### ✅ Approved Technologies (already in stack)

All technologies used in this feature are pre-approved:

- **TypeScript 5.x** (strict mode) - Language (Core technology)
- **React Router v7** - Frontend framework (Core technology)
  - useFetcher for optimistic UI updates
  - No new routes needed
- **Zod** - Validation library (Standard library)
  - Path parameter validation
  - Error response validation
- **Express** - Backend framework (Core technology)
  - DELETE /api/tweets/:id endpoint
- **postgres** npm package - Database client (Standard library)
  - Existing deleteTweet function
- **JWT (httpOnly cookies)** - Authentication (Security standard)
  - Existing authenticate middleware
- **Tailwind CSS** - Styling (UI library)
- **Flowbite** - UI components (UI library)
  - Modal component for confirmation dialog

### ➕ New Technologies (auto-added)

**None** - This feature introduces zero new dependencies

### ⚠️ Conflicting Technologies (require approval)

**None** - No conflicts detected

### ❌ Prohibited Technologies (cannot use)

**None** - All technologies compliant with tech-stack.md

---

**Tech Stack Status:** ✅ **100% APPROVED** - No tech stack changes required

---

## Constitution Compliance Check

Before proceeding, verify this plan complies with ALL principles in `/memory/constitution.md`:

- [x] **Principle 1 (Functional Programming):** Design uses pure functions (deleteTweet, no classes), functional components with hooks
- [x] **Principle 2 (Type Safety):** All boundaries have TypeScript types + Zod schemas (deleteTweetParamsSchema, error responses)
- [x] **Principle 3 (Programmatic Routing):** No new routes in app/routes.ts (uses React Router action via useFetcher)
- [x] **Principle 4 (Security-First):** Authentication (JWT middleware), authorization (ownership check in query), parameterized SQL, input validation (Zod UUID check)
- [x] **Principle 5 (Modern React):** Uses hooks (useState, useEffect, useFetcher), functional components, composition, optimistic UI via fetcher (not useEffect)

**Compliance Notes:**
- Optimistic UI updates use React Router useFetcher pattern (not useEffect or client state)
- DELETE operation enforces ownership at database level (single query prevents TOCTOU)
- Modal component from Flowbite (pre-approved UI library)
- No classes, no file-based routes, no prohibited patterns

**Status:** ✅ **FULLY COMPLIANT** with all 5 constitution principles

---

## Overview

**Goal:** Allow authenticated users to delete their own tweets with confirmation, preventing accidental deletion while providing instant feedback.

**User Value:**
- Content control: Users can remove tweets they regret or no longer want visible
- Safety: Confirmation modal prevents accidental deletion
- Instant feedback: Optimistic UI update shows immediate result

**Scope:**

**Included:**
- Delete button on TweetCard (own tweets only)
- Confirmation modal with tweet preview
- DELETE /api/tweets/:id API endpoint with authorization
- Optimistic UI update (tweet disappears immediately)
- Error handling with toast notifications
- Cascade deletion of associated likes

**Excluded:**
- Bulk deletion (users must delete one at a time)
- Soft delete or "recently deleted" folder
- Undo functionality (P2 enhancement)
- Admin deletion override
- Deletion analytics (P2 enhancement)

---

## Technical Approach

### Architecture

**Pattern:** RESTful DELETE endpoint + React Router optimistic updates

**Flow:**
```
User clicks delete button
       ↓
Confirmation modal appears
       ↓
User confirms deletion
       ↓
Optimistic UI update (tweet disappears immediately)
       ↓
DELETE /api/tweets/:id request sent
       ↓
Server validates ownership + deletes tweet
       ↓
Success: Toast notification, stay removed
       ↓
Error: Tweet reappears, error toast with retry
```

**Key Patterns:**
- Single query for ownership check + deletion (atomic, prevents TOCTOU)
- Database CASCADE handles like deletion automatically
- React Router useFetcher for optimistic updates (no client state)
- Functional components with hooks (no classes)
- Zod validation at API boundary (security)

### Data Model Changes

**Database Changes:**
- [x] No schema changes required
- [x] Uses existing `tweets` table
- [x] Cascade deletion via existing FK constraint on `likes.tweet_id`

**Type Definitions:**
```typescript
// TypeScript interfaces (camelCase)
interface DeleteTweetParams {
  id: string; // Tweet UUID
}

type DeleteTweetResponse = void; // 204 No Content

interface DeleteTweetError {
  error: string;
  details?: string;
}
```

**Zod Schemas:**
```typescript
// Validation schemas for boundaries
const deleteTweetParamsSchema = z.object({
  id: z.string().uuid('Invalid tweet ID format'),
});

const deleteTweetErrorSchema = z.object({
  error: z.string(),
  details: z.string().optional(),
});
```

### API Design

**New Endpoints:**
- `DELETE /api/tweets/:id` - Delete tweet by ID
  - Request: Path param (tweet ID as UUID)
  - Response: 204 No Content (success), Error object (failure)
  - Auth: Required (JWT in httpOnly cookie)
  - Authorization: Users can only delete their own tweets (profile_id check)
  - Validation: Zod schema validates UUID format

**Modified Endpoints:**
- None

**Database Operation:**
```typescript
// Pure function: check ownership + delete in single query
async function deleteTweet(
  db: Sql,
  tweetId: string,
  userId: string
): Promise<boolean> {
  const result = await db`
    DELETE FROM tweets
    WHERE id = ${tweetId}
      AND profile_id = ${userId}
    RETURNING id
  `;
  return result.length > 0;
}
```

### Frontend Components

**New Components:**
- `DeleteConfirmationModal` - Flowbite modal with tweet preview, confirm/cancel buttons
  - Props: `{ isOpen, tweetContent, onConfirm, onCancel, isDeleting }`
  - Features: ESC key, click outside, loading state, accessibility
- `DeleteButton` - Trash icon button that opens modal, handles fetcher
  - Props: `{ tweetId, tweetContent, onDeleteSuccess }`
  - State: `isModalOpen` (local), `isDeleting` (from fetcher.state)
  - Uses: useFetcher for DELETE request, useState for modal

**Modified Components:**
- `TweetCard` - Add delete button conditionally
  - New prop: `currentUserId?: string`
  - Logic: Show DeleteButton only when `currentUserId === tweet.author.id`
  - Optimistic UI: Hide card when `isOptimisticallyDeleted === true`

**Routing Changes:**
```typescript
// No changes to app/routes.ts
// DELETE action handled via fetcher.submit() to /api/tweets/:id
```

### State Management

**Local State:**
- `isModalOpen`: boolean (DeleteButton component) - controls modal visibility
- `isOptimisticallyDeleted`: boolean (TweetCard component) - hides card on delete

**Server State:**
- No client-side caching of tweets (uses React Router loaders)
- useFetcher handles DELETE request state (`idle`, `submitting`, `loading`)
- On error: Revert optimistic update via `fetcher.data.error` check

**No Redux, no global state** - follows Principle 5 (Modern React)

---

## Security Considerations

- [x] Input validation with Zod on client and server
  - Client: UUID format check before API call
  - Server: Zod schema validates path parameter
- [x] Authentication requirements identified
  - DELETE endpoint uses `authenticate` middleware
  - Requires valid JWT in httpOnly cookie
- [x] Authorization checks in place
  - Ownership validated in database query: `WHERE profile_id = ${userId}`
  - Single query prevents TOCTOU race condition
  - Returns 404 for both not-found and not-owned (prevents ownership leak via timing)
- [x] No sensitive data in localStorage/client state
  - JWT in httpOnly cookies only
  - Tweet content not stored client-side (optimistic update uses existing data)
- [x] Parameterized database queries only
  - Uses postgres package with template literals (automatic parameterization)
  - No string concatenation, no SQL injection risk

**Threat Mitigation:**
1. **Unauthorized deletion** → Ownership check in WHERE clause
2. **SQL injection** → Parameterized query + Zod UUID validation
3. **CSRF** → httpOnly cookies + SameSite attribute
4. **Replay attacks** → Idempotent DELETE (no side effects on repeat)
5. **Timing attacks** → Return 404 for both not-found and not-owned

---

## Testing Strategy

**Unit Tests:**
- [x] Pure functions and hooks
  - `deleteTweet(db, tweetId, userId)` - test success, not found, not owned
  - `deleteTweetParamsSchema.safeParse()` - test valid/invalid UUIDs
- [x] Zod schema validation
  - Valid UUID: passes
  - Invalid UUID: fails with error
  - Missing ID: fails with error
- [x] Component rendering
  - DeleteButton: renders trash icon, opens modal on click
  - DeleteConfirmationModal: renders tweet content, handles confirm/cancel
  - TweetCard: shows delete button only when currentUserId matches author

**Integration Tests:**
- [x] API endpoints with authentication
  - DELETE /api/tweets/:id with auth → 204
  - DELETE /api/tweets/:id without auth → 401
  - DELETE /api/tweets/:id (not owned) → 404
  - DELETE /api/tweets/:id (invalid UUID) → 400
- [x] Database operations
  - Delete tweet → tweet removed from database
  - Delete tweet → associated likes removed (cascade)
  - Delete tweet (not owned) → tweet remains, returns false
- [x] Full user flows
  - Delete own tweet from feed → succeeds
  - Delete own tweet from profile → succeeds
  - Try to delete another user's tweet → fails with 404

**Manual Testing:**
- [x] User flows documented (see quickstart.md)
- [x] Edge cases identified
  - Delete already-deleted tweet → 404
  - Network error → error toast, revert optimistic update
  - Multiple rapid delete clicks → button disabled during submission
  - ESC key closes modal without deleting
  - Click outside modal closes without deleting

---

## Implementation Phases

### Phase 1: Backend DELETE API (60 minutes)

**Tasks:**
1. Add `deleteTweet` function to `src/db/tweets.ts` (15 min)
   - Single query: ownership check + deletion
   - Return boolean (true if deleted)
2. Add `deleteTweetParamsSchema` to `src/schemas/tweet.ts` (5 min)
   - Zod schema for UUID validation
3. Implement `DELETE /api/tweets/:id` endpoint in `src/routes/tweets.ts` (30 min)
   - Add authenticate middleware
   - Validate UUID with Zod
   - Call deleteTweet function
   - Return 204 on success, 404 on not found, 400/401/500 on errors
4. Write tests for deleteTweet function and DELETE endpoint (10 min)
   - Test success, not found, not owned, invalid UUID

**Deliverables:**
- Working DELETE /api/tweets/:id endpoint with authorization
- Cascade deletion of likes handled automatically
- All backend tests passing

### Phase 2: Frontend Components (90 minutes)

**Tasks:**
1. Create `app/components/DeleteConfirmationModal.tsx` (30 min)
   - Flowbite Modal component
   - Display tweet content preview
   - Confirm/Cancel buttons
   - Loading state during deletion
   - ESC key and click-outside handling
2. Create `app/components/DeleteButton.tsx` (30 min)
   - Trash icon button
   - useState for modal visibility
   - useFetcher for DELETE request
   - Handle success (optimistic update callback)
   - Handle error (toast notification)
3. Modify `app/components/TweetCard.tsx` (30 min)
   - Add `currentUserId` prop
   - Conditionally render DeleteButton
   - Add optimistic UI state (isOptimisticallyDeleted)
   - Hide card when optimistically deleted
   - Stop event propagation on delete button

**Deliverables:**
- DeleteConfirmationModal component (tested)
- DeleteButton component with useFetcher (tested)
- TweetCard modified to show delete button on own tweets
- All component tests passing

### Phase 3: Integration (30 minutes)

**Tasks:**
1. Update `app/pages/Feed.tsx` to pass currentUserId to TweetCard (10 min)
   - Extract currentUserId from existing /api/auth/me call in loader
   - Pass to each TweetCard component
2. Update `app/pages/Profile.tsx` (same pattern) (10 min)
   - currentUserId already in Profile loader
   - Pass to TweetCard components
3. Update `app/pages/TweetDetail.tsx` (same pattern) (10 min)
   - Add currentUserId to loader
   - Pass to TweetCard

**Deliverables:**
- All three pages (Feed, Profile, TweetDetail) integrated with delete functionality
- Delete button visible only on own tweets across all pages
- Optimistic UI update works on all pages

### Phase 4: Testing & Polish (60 minutes)

**Tasks:**
1. End-to-end testing (30 min)
   - Manual test flow (see quickstart.md)
   - Verify delete button visibility
   - Verify modal behavior
   - Verify optimistic UI update
   - Verify database deletion + cascade
2. Error handling testing (20 min)
   - Network offline test
   - Delete already-deleted tweet
   - Invalid UUID format
   - Unauthorized deletion attempt
3. Accessibility testing (10 min)
   - Keyboard navigation (Tab, Enter, ESC)
   - Focus trap in modal
   - Screen reader testing
   - ARIA labels verification

**Deliverables:**
- All manual tests passed
- Error scenarios handled gracefully
- Accessibility requirements met
- Feature ready for production

---

## Dependencies

**External Dependencies:**
- None - uses existing libraries (Flowbite, React Router, Zod)

**Internal Dependencies:**
- [x] Authentication system (JWT, authenticate middleware)
- [x] TweetCard component
- [x] Database connection (createDbConnection)
- [x] React Router fetcher API

**Blockers:**
- None

---

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Accidental deletion | Medium | Low | Confirmation modal ALWAYS required, no "Don't ask again" checkbox |
| Race condition (multiple delete clicks) | Low | Low | Disable button while submitting, optimistic UI prevents second click |
| Network failure during delete | Low | Medium | Revert optimistic update on error, show error toast with retry button |
| TOCTOU (check-then-delete race) | Medium | Very Low | Single query for ownership check + deletion (atomic operation) |
| Cascade deletion failure | High | Very Low | Database FK constraint ensures atomic deletion (tweet + likes in transaction) |

---

## Success Criteria

- [x] Feature works as specified (delete own tweets with confirmation)
- [x] All tests pass (unit, integration, manual)
- [x] Constitution principles followed (functional programming, type safety, security-first, modern React)
- [x] No TypeScript errors (strict mode)
- [x] No security vulnerabilities introduced (ownership validation, parameterized queries, auth required)
- [x] Code reviewed and approved (ready for review)

**Performance Criteria:**
- Delete operation completes in < 500ms (database + API)
- Optimistic UI update in < 16ms (single frame)
- No unnecessary re-renders

**Accessibility Criteria:**
- Keyboard navigation supported (Tab, Enter, ESC)
- Screen reader announces modal and actions
- Focus trap within modal
- Color contrast meets WCAG 2.1 AA standards

---

## Rollback Plan

If issues arise in production:

1. **Immediate:** Remove delete button from TweetCard (set `currentUserId={undefined}`)
   - Feature disappears but no data loss
   - No backend changes needed

2. **Short-term:** Disable DELETE endpoint via feature flag
   - Return 501 Not Implemented from endpoint
   - Frontend handles gracefully with error toast

3. **Full Rollback:** Revert all changes
   - Backend: Remove DELETE endpoint, remove deleteTweet function
   - Frontend: Restore TweetCard to previous version
   - No database migration needed (schema unchanged)

---

## Documentation Updates

- [ ] API documentation
  - Add DELETE /api/tweets/:id endpoint to API reference
  - Document error responses (400, 401, 404, 500)
- [ ] User-facing documentation
  - Add "Deleting Tweets" section to user guide
  - Explain confirmation modal and permanent deletion
- [ ] Developer documentation
  - Update TweetCard component docs (new currentUserId prop)
  - Document useFetcher pattern for optimistic updates
- [ ] CLAUDE.md updates if needed
  - No changes needed (existing patterns apply)

---

## Notes

**Design Decisions:**
- Hard delete chosen over soft delete for MVP simplicity
- Optimistic UI pattern provides instant feedback (modern UX expectation)
- Database CASCADE handles like deletion automatically (no N+1 queries)
- Single query for ownership check + deletion prevents TOCTOU race condition
- Returns 404 for both not-found and not-owned to prevent ownership leak via timing

**Future Enhancements (P2):**
- Undo functionality (5-second window before permanent deletion)
- Keyboard shortcut (Delete key on focused tweet)
- Toast notifications for success/error (currently P1)
- Deletion analytics (track deletion rate for content moderation)
- Soft delete with "recently deleted" folder

**Related Features:**
- Feature 002: Tweet Posting (existing tweets table)
- Feature 003: Like Functionality (cascade deletion of likes)
- Feature 909: User Profile Tweets Feed (delete works on profile pages)

---

## Planning Complete

**Status:** ✅ **APPROVED** - Ready for implementation

**Next Steps:**
1. Review this plan with maintainer
2. Begin Phase 1 (Backend DELETE API)
3. Follow quickstart.md for step-by-step implementation
4. Run `/specswarm:tasks` to generate detailed task breakdown

**Estimated Completion:** 3-4 hours (1 developer)

**Contact:** See spec.md for questions or clarifications
